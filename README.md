# Unofficial Cipp Redirect Azure Function
I wanted to create an Autotask Livelink to alow my team to jump directly to the users page in the CyberDrain Improved Partner Portal.<br/>
I changed my process to modify this to use Azure functions so it can be easily integrated into any system.<br/>
I am using this project to learn Azure Functions, the MS Graph API and Powershell.  I apologise in advance for my terrible powershell script layout.<br/>

#Important Notes
This requires you to have the The CyberDrain Improved Partner Portal configured https://github.com/KelvinTegelaar/CIPP<br/>
Also there are better ways to link into your Secure App Model using the Azure Vault.  I am working on learning how that works this currently requred you to save your keys into the Azure Function APP Keys.<br/>
Please lock down your Azure functions to trusted individuals to keep those keys safe<br/>

**UpdateUsers** is an Azure Timer Function.  Upload UpdateUsers.ps1 to this function.
This function will automatically download a csv file of all your tenants containing the UserPrincipalName, DefaultDomainName of the Tenant and the User Object id.
It is set to run once a day at the moment in my tenancy

**cippredirect** is a Azure HTTP Function that allows you do a URL Redirect using powershell. <br/>
Upload the following files to this function:<br/>
* CIPPRedirect.ps1<br/>
* Office365UsersReport.csv<br/>

This Azure HTTP Function allows you to append your customers email address to the Azure Function URL and it will find the relevant information in the Office365UsersReport.csv that is generated by the UpdateUsers.ps1. It will search both the User Principal Name, all proxy addres and return an error if it cannot find the user. You can also modify the url to redirect to the Business Email Compromise Overview

User Page: https://xxx.azurewebsites.net/api/cippredirect?code=XXX=&email=Example@xxx.com<br/>
Business Email Compromise Overview Page: https://xxx.azurewebsites.net/api/cippredirect?code=XXX=&email=Example@xxx.com&compromise=yes<br/>

Once you create your new Azure function you need to create the following Application Settings under Configuration<br/>
ApplicationId<br/>
ApplicationSecret<br/>
RefreshToken<br/>
MyTenant<br/>

#**As an Autotask livelink**

**View the user in CIPP<br/>**
LiveLink Name: CIPP - View User<br/>
Label: CIPP - View User<br/>
BaseURL: https://xxx.azurewebsites.net/api/cippredirect?code=XXX=&<br/>
Querystring Values:<CONTACTE-MAILADDRESS><br/>
Catergory Service Desk<br/>
Entity Ticket<br/>
Configuration: Select the following<br/>
	-Ticket Details Window – Service Desk<br/>
	-Ticket Grid – Service Desk<br/>

**Direct to the Business Email Compromise Overview.  Note I link this to the individual contacts live links<br/>**
LiveLink Name: CIPP - Research Compromise User<br/>
Label: CIPP - Research Compromise User<br/>
Category: Service Desk<br/>
Entity Contact<br/>
BaseURL: https://xxx.azurewebsites.net/api/cippredirect?code=XXX=&<br/>
Querystring Values:email=<CONTACTE-MAILADDRESS>&compromise=yes<br/>
Configuration: Select the following<br/>
	-Contact Details Window - CRM<br/>
	-Contact Grid - CRM	<br/>
	-Contact Grid - Directory<br/>
	-Edit Contact Window <br/>
	-Edit Contact Window <br/>
	-Note Edit Window<br/>
	-Note Grid<br/>
	-To-Do Edit Window<br/>
	-To-Do Grid <br/>
	


I have been reading and learning from the following individuals.  I am in the process of re-writing the powershell scripts as I get a better understanding of how all of this works
	
All credit is for the original authors.

* Thanks to **Kelvin Tegelaar** for creating his blog https://cyberdrain.com/ and The CyberDrain Improved Partner Portal https://github.com/KelvinTegelaar/CIPP<br/>
* **Luke Whitelock** and his block specifically the CIPP Hudu intergration. https://mspp.io/hudu-microsoft-365-integration-and-updated-magic-dash-v3/<br/>
* **Gavin Stone** and his indepth blog post on setting up the Secure Application Model https://www.gavsto.com/secure-application-model-for-the-layman-and-step-by-step/<br/>
* Thanks to all other developers who are working on CIPP and making it better on a daily basis.
	
